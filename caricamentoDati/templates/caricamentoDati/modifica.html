{% extends 'base.html' %}
{% block title %}
  Modifica
{% endblock %}
{% block content %}
  <div class="main">
    <h1>Modifica {{ valutazione.nome }}, {{ valutazione.anno }}. Pubblicazioni richieste per autore: {{ valutazione.numeroPubblicazioni }}</h1>
    <div style="display: flex;">
      <div style="padding: 20px;">
        <h2>Cancella tutte le pubblicazioni</h2>
        <form method="post" action="{% url 'cancella_pubblicazioni_tot' valutazione.nome %}">
          {% csrf_token %}

          <button class="btn" type="submit">Cancella</button>
        </form>
      </div>
      <div style="padding: 20px;">
        <h2>Carica pubblicazioni</h2>
        <form method="post" enctype="multipart/form-data" action="{% url 'caricamento_con_file' filename='temp' valutazione=valutazione.nome %}">
          {% csrf_token %}
          <label for="filename">Seleziona un file CSV:</label>
          <input type="file" name="filename" id="filename" />
          <br />
          <button class="btn" type="submit">Carica</button>
        </form>
      </div>




        <!-- Altro contenuto precedente al pulsante del modale -->

<!-- Pulsante per aprire il modale -->
<button type="button" class="btn" onclick="openModal()">Apri Modale</button>

<!-- Modal -->
<div id="modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalLabel">Aggiungi Pubblicazione</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <!-- Form di aggiunta pubblicazione -->
        <form id="aggiungi_pubblicazione_form" method="post" action="{% url 'aggiungi_pubblicazione' valutazione_nome=valutazione.nome docente=docente %}">
          {% csrf_token %}
          {{ form_aggiungi_pubblicazione.as_p }}
          <button class="btn" type="submit">Aggiungi</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Altro contenuto dopo il modale -->





  




<!--
      <div style="padding: 20px;">
        <h2>Modal</h2>
        <button type="button" class="btn" data-toggle="modal" data-target="#modal" data-url="{% url 'aggiungi_pubblicazione_pagina' valutazione_nome=valutazione.nome caller='caller' docente='admin' %}">Aggiungi pubblicazione</button>
      </div>
    -->  

      <div style="padding: 20px;">
        <h2>Carica nuova pubblicazione</h2>

        <button onclick="openPopup()" class="btn">Aggiungi pubblicazione</button>

        <script>
          function openPopup() {
            var url = "{% url 'aggiungi_pubblicazione_pagina' valutazione_nome=valutazione.nome caller='caller' docente='admin' %}"
            window.open(url, 'popupWindow', 'width=1800,height=800,scrollbars=yes')
          }
        </script>
      </div>

      <div style="padding: 20px;">
        <h2>Riviste eccellenti</h2>

        <button onclick="openPopup2()" class="btn">Modifica riviste eccellenti</button>

        <script>
          function openPopup2() {
            var url = "{% url 'riviste_eccellenti' valutazione_nome=valutazione.nome %}"
            window.open(url, 'popupWindow', 'width=1800,height=800,scrollbars=yes')
          }
        </script>
      </div>
    </div>
    <div style="padding-top: 80px;">
      {% if pubblicazioni %}
        <h2>Pubblicazioni</h2>
        <table id="table-pubblicazioni" class="table table-bordered">
          <thead>
            <tr>
              <th style="vertical-align: top; text-align: left;" data-orderable="true">
                <b>Titolo</b>
              </th>
              <th data-orderable="true" style="vertical-align: top; text-align: left;">
                <b>Anno di pubblicazione</b>
              </th>
              <th data-orderable="true" style="vertical-align: top; text-align: left;">
                <b>Miglior quartile</b>
              </th>
              <th data-orderable="true" style="vertical-align: top; text-align: left;">
                <b>Numero di coautori del dipartimento</b>
              </th>
              <th style="vertical-align: top; text-align: left;">
                <b>Azioni</b>
              </th>
            </tr>
          </thead>
          {% for pubblicazione in pubblicazioni %}
            <tr>
              <td>{{ pubblicazione.titolo }}</td>
              <td>{{ pubblicazione.anno_pubblicazione }}</td>
              <td>{{ pubblicazione.miglior_quartile }}</td>
              <td>{{ pubblicazione.num_coautori_dip }}</td>
              <td>
                <div type="button" style="padding-left: 40px;">
                  <form method="post" action="{% url 'cancella_pubblicazione_singola' valutazione_nome=valutazione.nome pubblicazione_titolo=pubblicazione.titolo %}">
                    {% csrf_token %}

                    <button class="btn" type="submit">Cancella</button>
                  </form>
                </div>
              </td>
            </tr>
          {% endfor %}
        </table>
      {% else %}
        <p>Non ci sono pubblicazioni disponibili.</p>
      {% endif %}
    </div>
  </div>


  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Listener per il form di aggiunta pubblicazione
      var form = document.querySelector('#aggiungi_pubblicazione_form');
      form.addEventListener('submit', function(event) {
        event.preventDefault(); // Evita il comportamento predefinito del form

        // Esegui una richiesta AJAX per aggiungere la pubblicazione
        fetch(form.action, {
            method: 'POST',
            body: new FormData(form),
            headers: {
              'X-CSRFToken': '{{ csrf_token }}'
            }
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Chiudi il modale al termine dell'operazione
              $('#modal').modal('hide');
              location.reload(); // Opzionale: Ricarica la pagina o aggiorna la tabella con i nuovi dati
            } else {
              // Gestisci errori o altre situazioni qui
              console.error('Errore durante l\'aggiunta della pubblicazione');
            }
          })
          .catch(error => {
            console.error('Si Ã¨ verificato un errore:', error);
          });
      });
    });
  </script>
  <script>
    // Funzione per aprire il modale
    function openModal() {
      $('#modal').modal('show'); // Mostra il modale
    }
  </script>
{% endblock %}
